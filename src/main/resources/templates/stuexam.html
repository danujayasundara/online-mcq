<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exams</title>
    <link rel="stylesheet" th:href="@{../css/stustyle.css}">
</head>
<body>
    <header>
        <div class="mainheader">
            <img src="image/logo.png" alt="Logo">
            <h1>Edueye</h1>
        </div>
    </header>

    <div class="stumain">
        <div class="studashboard">
            
            <ul>
                <li><a th:href="@{/user-page}">Home</a></li>
                <li><a th:href="@{/stuexam}">Exam</a></li>
                <!--<li><a href="sturesult.html">Result</a></li>-->
                <li><a th:href="@{/logout}">Logout</a></li>
            </ul>
        </div>
        <div class="examrightcont">
            <div class="searchtable">
                <table>
                    <tr>
                    	<form id="searchForm">
						    <th><input type="text" id="searchInput" name="examName"></th>
						    <th id="search"><button id="searchButton" type="submit">Search</button></th>
						</form>
                    </tr>
                </table>
            </div>
            <div class="examtable">
                <table>
	                <thead>
	                    <tr>
	                        <th id="exam"><a href="exampaper.html">Exam</a></th>
	                        <th>Starting Time</th>
	                        <th>Exam Duration</th>
	                        <th>Status</th>
	                    </tr>
	                </thead>
                    <tbody>
			            <tr th:each="exam : ${exams}" class="searchable" onclick="myFunction(this)" data-examid="${exam.exam_id}" data-userid="${loggedInUserId}"
			            id="examList">
			                <td><a th:href="@{'/' + ${exam.exam_id} + '/questions'(examId=${exam.exam_id}, userId=${loggedInUserId})}" 
			                th:text="${exam.exam_name}" style="color: black;" id = "examLink" class="examLink"
			                data-exam-id="${exam.exam_id}"></a></td>
			                <td th:text="${exam.dateTime}"></td>
			                <td th:text="${exam.duration}"></td>
			                <td th:text="${exam.e_status == 1 ? 'Attended' : 'Pending'}" id="statusDisplay"></td>
			                <!--<td th:text="${examAttempt?.attemptstatus == 1 ? 'Attended' : 'Pending'}" id="statusDisplay"></td>-->
			            </tr>
        			</tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <div class="mainfooter">
            &copy; 2024 EduEye. All rights reserved.
        </div>
    </footer>
     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    	document.getElementById('searchForm').addEventListener('submit', function(event) {
			    event.preventDefault();
			    const exam_name = document.getElementById('searchInput').value;
			    searchExam(exam_name);
			    
			    function searchExam(exam_name) {
		    	fetch(`/studentexam?exam_name=${encodeURIComponent(exam_name)}`)
		        .then(response => response.json())
		        .then(data => {
		            
		            console.log(data);
		        })
		        .catch(error => console.error('Error:', error));
		}
		});
		
		/*<![CDATA[*/
	    function myFunction(row) {
	        const examId = row.getAttribute('data-examid');
	        const userId = row.getAttribute('data-userid');
	        console.log('Clicked Exam ID:', examId);
	        console.log('User ID:', userId);
	        
	        //let attemptStatus = $(row).find('td:last').text().trim().toLowerCase() === 'attended' ? 1 : 0; 
	
	        // window.location.href = '/exampaper?examId=' + examId + '&userId=' + userId;
	    }
	    /*]]>*/
	    
	    
	    // develop search bar
	     $(document).ready(function() {
	        $('#searchForm').submit(function(e) {
	            e.preventDefault(); 
	
	            var searchText = $('#searchInput').val().toLowerCase().trim();
	            $('.searchable').each(function() {
	                var examName = $(this).find('td:first-child').text().toLowerCase(); 
	                if (examName.includes(searchText)) {
	                    $(this).addClass('highlight'); 
	                } else {
						alert('No matching exam found.');
	                    $(this).removeClass('highlight');
	                }
	            });
	        });
	    });
	    
	    //end exam for students
		document.addEventListener('DOMContentLoaded', function() {
		    // Check if ended exam IDs are already stored in localStorage
		    var storedEndedExamIds = JSON.parse(localStorage.getItem('endedExamIds'));
		
		    // Fetch the list of ended exam IDs from the backend if not stored in localStorage
		    $.ajax({
		        url: '/ended-exams', // Adjust the URL to match your backend endpoint
		        method: 'GET',
		        success: function(response) {
		            console.log('Ended Exam IDs:', response);
		            localStorage.setItem('endedExamIds', JSON.stringify(response)); // Store the response in localStorage
		            disableEndedExamLinks(response); // Pass stored exam IDs to the function
		        },
		        error: function(xhr, status, error) {
		            console.error('Error fetching ended exam IDs:', error);
		        }
		    });
		
		    console.log('storedEndedExamIds', storedEndedExamIds);
		
		    function disableEndedExamLinks(storedEndedExamIds) {
		        var examLinks = document.querySelectorAll('.examLink');
		        var examIds = []; // Array to store all exam IDs
		
		        examLinks.forEach(function(link) {
		            var href = link.getAttribute('href');
		            if (href) {
		                var examId = href.split('/')[1]; // Extract the exam ID from the href
		                if (examId) { // Check if examId is not null or undefined
		                    examIds.push(examId); // Add the exam ID to the array
		                    console.log('Exam ID from link:', examId);
		
		                    // Check if the exam ID is in the list of ended exam IDs
		                    if (storedEndedExamIds.includes(parseInt(examId))) {
		                        disableExamLink(link); // Disable the link if the exam is ended
		                    }
		                }
		            }
		        });
		
		        console.log('All Exam IDs:', examIds);
		    }
		
		    function disableExamLink(link) {
		        link.classList.add('disabled');
		        link.setAttribute('disabled', true);
		        link.style.color = 'gray';
		        link.style.pointerEvents = 'none';
		        link.setAttribute('title', 'This exam is no longer available');
		        link.addEventListener('click', function(event) {
		            event.preventDefault();
		            alert('This exam is no longer available.');
		        });
		    }
		
		    function enableExamLink(link) {
		        // Optionally, you can add specific styling or behavior for enabled links here if needed
		    }
		});

    </script>
</body>
</html>